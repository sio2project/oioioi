name: Cypress nightly tests

on:
  schedule:
    - cron: '15 5 * * *'
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Install `easy_toolbox.py` requirements
        run: |
          python -m pip install --upgrade pip
          pip install -U inquirer

      - name: Build OIOIOI
        run: |
          python easy_toolbox.py build --no-input

      - name: Containers `up`
        run: |
          python easy_toolbox.py up --no-input

      - name: Wait for migrations
        uses: whatnick/wait-action@master
        with:
          time: 30s

      - name: Run test server
          python easy_toolbox.py server-cypress --no-input &

      - name: Run tests
        run: |
          pushd oioioi_cypress
          yarn
          npx wait-on http://localhost:8000
          CYPRESS_baseUrl=http://localhost:8000 yarn cy:run
          popd
